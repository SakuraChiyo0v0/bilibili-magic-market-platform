# Bilibili Magic Market Pro - 产品演进路线图

本文档旨在规划从“个人爬虫工具”向“多用户SaaS/社区化产品”转型的功能架构与开发计划。

## 阶段一：用户体系与权限 (Foundation)
**目标**：实现多用户隔离，确保数据安全，区分管理员与普通用户。

### 1.1 用户认证系统 (Auth)
- [x] **注册/登录**：支持用户名/密码注册，未来可扩展邮箱/手机号验证。
- [x] **JWT 鉴权**：使用 OAuth2 + JWT (JSON Web Tokens) 进行无状态身份验证。
- [x] **密码加密**：使用 bcrypt 或 Argon2 对用户密码进行哈希存储。

### 1.2 角色与权限 (RBAC)
- [x] **角色划分**：
    - `Admin`：拥有所有权限，可配置爬虫参数、管理所有用户、查看系统日志。
    - `User`：仅能查看商品、管理自己的关注列表、设置自己的推送通知。
- [x] **接口保护**：后端 API 增加 `Depends(get_current_active_user)` 依赖注入，区分公开接口与私有接口。

### 1.3 个人中心
- [x] **个人资料**：修改昵称、头像、修改密码。
- [ ] **API Key 管理**：(高级功能) 为高级用户提供 API Key，允许他们通过代码访问数据。

---

## 阶段二：个性化与触达 (Engagement)
**目标**：让用户从“被动看看板”转变为“主动收消息”，建立个人资产库。

### 2.1 关注/收藏系统 (Watchlist)
- [x] **我的关注**：用户可以收藏感兴趣的商品 (Many-to-Many 关系)。
- [ ] **目标价格**：收藏时可设置“心理价位”。
- [x] **专属看板**：Dashboard 增加“我的关注”板块，只看自己关心的商品走势。

### 2.2 消息推送系统 (Notification)
**核心逻辑**：当 `当前价格 <= 目标价格` 或 `降幅 > X%` 时触发。
- [ ] **推送渠道集成**：
    - **邮件** (SMTP)：最通用，适合日报/周报。
    - **钉钉/飞书/企业微信机器人**：适合国内用户，实时性强。
    - **Telegram/Discord Bot**：适合极客用户。
    - **Web Push**：浏览器原生通知。
- [ ] **推送配置**：用户可自定义接收渠道和接收频率（防骚扰）。

### 2.3 资产管理 (Inventory)
- [ ] **持仓记录**：用户可手动录入自己已买入的商品及成本价。
- [ ] **盈亏分析**：实时计算 `(当前市场最低价 - 成本价) * 数量`，展示“浮动盈亏”。

---

## 阶段三：数据赋能与社区 (Intelligence)
**目标**：利用积累的大数据提供决策辅助，增加用户粘性。

### 3.1 智能分析
- [ ] **倒爷计算器**：详情页增加计算器，扣除 B 站手续费、提现费后，计算实际到手利润。
- [ ] **价格预测**：基于历史数据趋势，简单的线性回归预测未来一周价格走向（仅供参考）。
- [ ] **溢价率分析**：对比 `市场价` (官方定价) 与 `当前最低价`，计算溢价率/折扣率热力图。

### 3.2 社区互动
- [ ] **热门榜单**：展示“最多人关注”、“今日跌幅最大”、“成交量最高（需推算）”的商品。
- [ ] **评论/吐槽**：用户可在商品详情页留言（如：“这价位传家宝呢？”）。

---

## 阶段四：系统稳定性与反爬 (Infrastructure)
**目标**：应对多用户带来的高并发，以及 B 站日益严格的风控。

### 4.1 代理池系统 (Proxy Pool)
- [ ] **多 IP 轮询**：接入第三方代理 IP 服务，爬虫每次请求自动切换 IP。
- [ ] **Cookie 池**：支持录入多个 B 站账号 Cookie，轮询使用，分摊单账号风险。

### 4.2 任务队列优化
- [ ] **Celery/Redis**：引入 Redis 作为消息队列，替代目前的内存队列，支持分布式部署。
- [ ] **优先级队列**：用户手动触发的刷新任务优先级 > 自动巡检任务。

### 4.3 移动端适配 (Mobile)
- [ ] **PWA 支持**：优化前端 CSS，使其在手机浏览器上体验接近原生 App。
- [ ] **小程序**：(可选) 封装为微信小程序。

---

## 数据库设计变更预览 (Draft)

```sql
-- 用户表
CREATE TABLE users (
    id INT PRIMARY KEY,
    username VARCHAR(50) UNIQUE,
    hashed_password VARCHAR(255),
    role VARCHAR(20) DEFAULT 'user',
    email VARCHAR(100),
    created_at DATETIME
);

-- 关注表
CREATE TABLE favorites (
    user_id INT,
    goods_id INT,
    target_price FLOAT, -- 目标价
    notify_enabled BOOLEAN DEFAULT TRUE,
    PRIMARY KEY (user_id, goods_id)
);

-- 通知配置表
CREATE TABLE notification_settings (
    user_id INT PRIMARY KEY,
    webhook_url VARCHAR(255), -- 钉钉/飞书 Webhook
    email_enabled BOOLEAN,
    webhook_enabled BOOLEAN
);
```

---

## 阶段五：生态与黑科技 (Ecosystem & Advanced)
**目标**：构建护城河，提供人无我有的差异化体验。

### 5.1 浏览器插件 (Browser Extension)
- [ ] **官方页面注入**：开发 Chrome/Edge 插件，当用户访问 `mall.bilibili.com` 详情页时，自动在页面侧边注入“历史价格曲线”和“本站估值”。
- [ ] **一键关注**：在 B 站官方页面直接点击插件按钮，将商品加入本站关注列表。

### 5.2 卖家透视 (Seller Lens)
- [ ] **卖家画像**：分析某卖家是“良心玩家”还是“传家宝倒爷”（基于其所有挂单的平均溢价率）。
- [ ] **黑名单系统**：用户可屏蔽特定卖家，搜索结果中不再显示其挂单。

### 5.3 疑似成交价推算 (Transaction Inference)
- [ ] **成交判定算法**：若 `最低价挂单` 在 `N分钟` 内消失 且 `库存 -1`，则判定为“疑似成交”。
- [ ] **成交行情**：展示“最近 5 笔疑似成交价”，比挂单价更真实的行情参考。

### 5.4 跨平台比价辅助
- [ ] **一键比价**：在详情页提供跳转按钮，自动带入关键词跳转至“闲鱼”、“淘宝”、“日拍”搜索页，方便用户横向比价。
